#!/bin/bash

export PATH={{ansible_env.PATH}}

dest_base_dir={{dest_base_dir}}
prog_dir=/opt/tomcat
echo "--------------------`date` begin-----------------"
prog=({{source_log_dir |join(' ')}})
log_dir=(logs log4j2logs)
declare -A log_map
{% raw %}
# 循环应用程序目录
log_map=([logs]="catalina catalina.out localhost localhost_access_log" [log4j2logs]="global global_api_inner global_api_outside")
for p in ${prog[@]};do
    # 循环应用程序下的 tomcat 日志和 业务日志目录
    for dir in ${log_dir[@]};do
        if [ -d ${prog_dir}/${p}/${dir} ];then
            echo "cd ${prog_dir}/${p}/${dir}"
            cd ${prog_dir}/${p}/${dir}
            pwd
        else
            echo "the ${prog_dir}/${p}/${dir} is not exist. continue"
            continue
        fi
#        for i in ${log_map[${dir}]};do
#            echo "log name is ${i}"
#            sleep 1
#        done
        
        log_type=${log_map[${dir}]}
        dest_dir=${dest_base_dir}/${p}_logs/${dir}
        for num in {2..10};do
            dt=$(date -d "${num} day ago" +%F)
            dir_dt=$(date -d ${dt} +%Y%m)
        
            for i in ${log_type};do
                if ls ${i}.${dt}* &> /dev/null;then
                    if test -e ${dest_dir}/${dir_dt}/${i};then
                        echo "mv ${i}.${dt}* to ${dest_dir}/${dir_dt}/${i}/"
                        mv ${i}.${dt}* ${dest_dir}/${dir_dt}/${i}/
                    else
                        echo "mkdir -p ${dest_dir}/${dir_dt}/${i}"
                        mkdir -p ${dest_dir}/${dir_dt}/${i}
                        echo "mv ${i}.${dt}* to ${dest_dir}/${dir_dt}/${i}/"
                        mv ${i}.${dt}* ${dest_dir}/${dir_dt}/${i}/
                    fi
                fi
            done
        done
    done
done

# delete old log dir
for prog_name in ${prog[@]};do
    for log_type in ${log_dir[@]};do
        echo "cd ${dest_base_dir}/${prog_name}_logs/${log_type}"
        cd ${dest_base_dir}/${prog_name}_logs/${log_type}
        echo 'find ./ \( -name "*.log" -or -name "catalina.out.*" \) -and -mtime +7 -exec rm -rf {} \;'
        find ./ \( -name "*.log" -or -name "catalina.out.*" \) -and -mtime +7 -exec rm -rf {} \;
        #date_dir=($(ls -1 |grep "[0-9]"))
        date_dir=($(ls -1 |grep "^[0-9]\{6\}$"))
        echo "${prog_name}/${log_type}   ${date_dir[@]}"

        length=${#date_dir[@]}
        
        #if [ ${length} -eq 4 ];then
        if [ ${length} -eq 2 ];then
            echo "old version is three."
        else
            #diff=$[length-4]
            diff=$[length-2]
            for((i=0;i<${diff};i++));do
                echo "delete  ${dest_base_dir}/${prog_name}_logs/${log_type}/${date_dir[${i}]}"
                rm -rf ${date_dir[${i}]}
            done
        fi
    done
done

app_warn_log=${prog_dir}/civp/log4j2logs/app/warn.log
app_error_log=${prog_dir}/civp/log4j2logs/app/error.log
echo "delete ${app_warn_log}"
echo 0 > ${app_warn_log}
echo "delete ${app_error_log}"
echo 0 > ${app_error_log}
echo "--------------------`date` end-----------------"
# delete old gc log
echo 'find /data/apps/log -name "*gc*.log" -mtime +180 -exec rm -rf {} \;'
find /data/apps/log -name "*gc*.log" -mtime +180 -exec rm -rf {} \;

{% endraw %}

