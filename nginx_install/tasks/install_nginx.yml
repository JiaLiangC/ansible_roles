
- name: get nginx packet dir name
  local_action: shell tar tvf {{nginx_packet}} |tail -n 1 |awk '{print $NF}' |awk -F'/' '{print $1}'
  register: nginx_dir_name
  run_once: true

- name: cp and unarchive nginx to remote host
  unarchive: 
    src: '{{ item.src }}' 
    dest: '{{ item.dest }}' 
    owner: '{{ nginx_run_user }}' 
    group: '{{ nginx_run_user }}' 
    creates: '{{ item.creates }}'
  with_items:
    - { src: '{{nginx_packet}}', dest: '{{ nginx_install_dir}}/', creates: '{{ nginx_install_dir }}/{{nginx_dir_name.stdout}}' }

- name: create nginx link dir
  file: 
    src: '{{ item.src }}' 
    dest: '{{item.dest}}' 
    state: '{{ item.state }}'
  with_items:
    - { src: "{{nginx_install_dir}}/{{nginx_dir_name.stdout}}", dest: "{{nginx_base_dir}}", state: link}
  when: nginx_dir_name.stdout != "nginx"

- name: create nginx link dir
  file: src={{ item.src }} dest={{item.dest}} state={{ item.state }}
  with_items:
    - { src: "{{nginx_conf_dir}}", dest: /etc/nginx, state: link}
    - { src: "{{nginx_base_dir}}", dest: /opt/nginx, state: link}
  #when: item.dest is not exists

