---
- name: copy logstash boot file
  copy: src={{ item.src }} dest={{ item.dest }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} backup=yes
  with_items:
    #- { src: 'logstash_rcs2.ini', dest: '{{supervisor_conf_dir}}/logstash_rcs2.ini', owner: root, group: root, mode: '0644' }
    - { src: '{{logstash_boot_file}}', dest: '{{supervisor_conf_dir}}/', owner: root, group: root, mode: '0644' }
  notify:
    - supervisor update
  ignore_errors: true

- name: copy logstash conf file
  #copy: src={{ item.src }} dest={{ item.dest }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} backup=yes
  template: src={{ item }} dest={{ logstash_conf_dir }} owner=root group=root mode=0644 backup=yes
  with_items: "{{logstash_confs}}"
    #- { src: 'logstash_rcs2-abevent-worker-info.conf', dest: '{{logstash_conf_dir}}/', owner: root, group: root, mode: '0644' }
    #- { src: 'logstash_rcs2-api-worker-info.conf', dest: '{{logstash_conf_dir}}/', owner: root, group: root, mode: '0644' }
    #- { src: 'logstash_rcs2-jobcli-info.conf', dest: '{{logstash_conf_dir}}/', owner: root, group: root, mode: '0644' }
    #- { src: 'logstash_rcs2-scheduler-info.conf', dest: '{{logstash_conf_dir}}/', owner: root, group: root, mode: '0644' }
    #- { src: 'logstash_rcs2-server-info.conf', dest: '{{logstash_conf_dir}}/', owner: root, group: root, mode: '0644' }
  register: result
- name: test register
  shell: echo "{{result}}" > /tmp/test_register

- name: restart rcs logstash when conf changed
  supervisorctl: name={{ item.item.split('/')[-1].split('.')[0] }} state=restarted config={{supervisor_prim_conf}} supervisorctl_path={{supervisor_exe_file}}
  with_items: "{{result.results}}"
  when: item.failed == False and item.changed == True


- name: start rcs logstash
  #supervisorctl: name={{ item.item.src.split('.')[0] }} state=started
  supervisorctl: name={{ item.item.split('/')[-1].split('.')[0] }} state=started config={{supervisor_prim_conf}} supervisorctl_path={{supervisor_exe_file}}
  with_items: "{{result.results}}"
    #- logstash_rcs2-abevent-worker-info
    #- logstash_rcs2-api-worker-info
    #- logstash_rcs2-jobcli-info
    #- logstash_rcs2-scheduler-info
    #- logstash_rcs2-server-info
