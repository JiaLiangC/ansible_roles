- name: create etcd user
  user: name={{etcd_run_user}} system=yes

- name: get etcd packet dir name
  local_action: shell tar tvf {{etcd_packet}} |tail -n 1 |awk '{print $NF}' |awk -F'/' '{print $1}'
  register: etcd_dir_name
  run_once: true

- name: create etcd dir
  file: path={{ item.path }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} state={{ item.state }}
  with_items:
    - { path: "{{app_base_dir}}", owner: root, group: root, mode: "0755", state: directory }
    - { path: "{{etcd_log_dir}}", owner: '{{etcd_run_user}}', group: '{{etcd_run_user}}', mode: "0755", state: directory }
    - { path: "{{etcd_data_dir}}", owner: '{{etcd_run_user}}', group: '{{etcd_run_user}}', mode: "0755", state: directory }
    - { path: "{{etcd_data_dir}}/{{etcd_name}}.etcd", owner: '{{etcd_run_user}}', group: '{{etcd_run_user}}', mode: "0755", state: directory }
    - { path: "{{etcd_data_dir}}/wal", owner: '{{etcd_run_user}}', group: '{{etcd_run_user}}', mode: "0755", state: directory }
    - { path: "{{etcd_var_dir}}", owner: '{{etcd_run_user}}', group: '{{etcd_run_user}}', mode: "0755", state: directory }
    - { path: "{{etcd_conf_dir}}", owner: '{{etcd_run_user}}', group: '{{etcd_run_user}}', mode: "0755", state: directory }
    - { path: "{{etcd_conf_dir}}/ssl", owner: '{{etcd_run_user}}', group: '{{etcd_run_user}}', mode: "0755", state: directory }

- name: cp and unarchive etcd_binary_tarball to remote host 
  unarchive: src={{ item.src }} dest={{ item.dest }} owner={{ etcd_run_user }} group={{ etcd_run_user }} creates={{ item.creates }}
  with_items:
    - { src: '{{etcd_packet}}', dest: '{{ app_base_dir}}/', creates: '{{ app_base_dir }}/{{etcd_dir_name.stdout}}', mode: "0755" }

- name: create etcd link dir
  file: src={{ item.src }} dest={{item.dest}} state={{ item.state }}
  with_items:
    - { src: "{{app_base_dir}}/{{etcd_dir_name.stdout}}", dest: '{{etcd_base_dir}}', state: link}
  when: etcd_dir_name.stdout != "etcd"

- name: create etcd conf dir link
  file: src={{ item.src }} dest={{item.dest}} state={{ item.state }}
  with_items:
    - { src: "{{etcd_conf_dir}}", dest: '/etc/etcd', state: link}
  ignore_errors: true

- name: copy etcd conf file
  template: src={{item.src}} dest={{item.dest}} owner={{item.owner}} group={{item.group}} mode={{item.mode}} backup=yes
  with_items:
    - {src: etcd.sh, dest: /etc/profile.d/, owner: root, group: root, mode: "0644"}
    - {src: etcd.systemd, dest: /usr/lib/systemd/system/etcd.service, owner: root, group: root, mode: "0644"}
    - {src: '{{etcd_work_dir}}/ansible_etcd_confs/etcd.conf', dest: '{{etcd_conf_dir}}', owner: '{{etcd_run_user}}', group: '{{etcd_run_user}}', mode: "0644"}
