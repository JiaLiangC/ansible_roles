
- name: get etcd packet dir name
  local_action: 
    module: shell
    cmd: tar tf {{etcd_packet}} |head -n 1 |awk -F'/' '{print $1}'
    args:
      warn: false
  register: etcd_dir_name
  run_once: true


- name: cp and unarchive etcd_binary_tarball to remote host 
  unarchive: 
    src: '{{ item.src }}' 
    dest: '{{ item.dest }}' 
    owner: '{{ etcd_run_user }}' 
    group: '{{ etcd_run_user }}' 
    creates: '{{ item.creates }}'
  with_items:
    - { src: '{{etcd_packet}}', dest: '{{ app_base_dir}}/', creates: '{{ app_base_dir }}/{{etcd_dir_name.stdout}}', mode: "0755" }

- name: create etcd link dir
  file: 
    src: '{{ item.src }}' 
    dest: '{{item.dest}}' 
    state: '{{ item.state }}'
  with_items:
    - { src: "{{app_base_dir}}/{{etcd_dir_name.stdout}}", dest: '{{etcd_base_dir}}', state: link}
  when: etcd_dir_name.stdout != "etcd"

- name: create etcd conf dir link
  file: 
    src: '{{ item.src }}' 
    dest: '{{item.dest}}' 
    state: '{{ item.state }}'
  with_items:
    - { src: "{{etcd_conf_dir}}", dest: '/etc/etcd', state: link}
  ignore_errors: true

