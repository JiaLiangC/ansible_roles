---
- name: copy filebeat.ini file
  copy: src={{ item.src }} dest={{ item.dest }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} backup=yes
  with_items:
    - { src: 'filebeat.ini', dest: '{{ supervisor_conf_dir }}/', owner: root, group: root, mode: '0644'}
  register: ini_result

#- name: test result
#  shell: echo "{{ini_result}}" > /tmp/test_result
- name: supervisor update
  shell: supervisorctl update
  when: ini_result.results[0].failed == False and ini_result.changed == True
  ignore_errors: true

- name: copy filebeat conf file
  copy: src={{ item.src }} dest={{ item.dest }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} backup=yes
  with_items:
    - { src: 'filebeat.yml', dest: '{{ filebeat_conf_dir }}/', owner: root, group: root, mode: '0644'}
  notify:
    - restart filebeat

- name: copy filebeat env file
  template: src={{ item.src }} dest={{ item.dest }} owner=root group=root mode={{ item.mode }}
  with_items:
    - { src: 'filebeat.sh', dest: '/etc/profile.d/', mode: '0644'}

- name: start filebeat
  supervisorctl: name={{ item }} state=started
  with_items:
    - filebeat
