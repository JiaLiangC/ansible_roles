- name: create redis user
  user: name={{ item.name }} state=present system={{ item.system }}
  with_items:
    - { name: '{{redis_run_user}}', system: yes}

- name: create redis dir
  file: path={{ item.path }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} state={{ item.state }}
  with_items:
    - {path: '{{app_base_dir }}', owner: root, group: root, mode: "0755", state: directory}
    - {path: '{{redis_var_dir}}', owner: '{{redis_run_user}}', group: '{{redis_run_user}}', mode: "0755", state: directory}
    - {path: '{{redis_log_dir}}', owner: '{{redis_run_user}}', group: '{{redis_run_user}}', mode: "0755", state: directory}
    - {path: '{{redis_conf_dir}}', owner: '{{redis_run_user}}', group: '{{redis_run_user}}', mode: "0755", state: directory}
    - {path: '{{redis_data_dir}}', owner: '{{redis_run_user}}', group: '{{redis_run_user}}', mode: "0755", state: directory}

- name: get redis packet dir name
  local_action: shell tar tvf {{redis_packet}} |head -n 1 |awk '{print $NF}' |awk -F'/' '{print $1}'
  register: redis_dir_name
  run_once: true

- name: cp and unarchive redis to remote host
  unarchive: src={{ item.src }} dest={{ item.dest }} owner={{ item.owner }} group={{ item.group }} creates={{ item.creates }}
  with_items:
    - {src: '{{ redis_packet }}', dest: '{{ app_base_dir }}/', owner: '{{redis_run_user}}', group: '{{redis_run_user}}', creates: '{{ app_base_dir }}/{{redis_dir_name.stdout}}'}

- name: create redis link dir
  file: src={{ item.src }} dest={{item.dest}} state={{ item.state }}
  with_items:
    - { src: "{{app_base_dir}}/{{redis_dir_name.stdout}}", dest: "{{redis_base_dir}}", state: link}
  when: redis_dir_name.stdout != "redis"

