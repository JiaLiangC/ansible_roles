# edirtor: haifeng
# 2017/01/12


- include: supervisor_{{supervisor_install_method}}_install.yml
#  when: supervisor_install_method == "local"

#- include: supervisor_net_install.yml
#  when: supervisor_install_method == "net"

- name: create dir
  file: path={{ item.path }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} state={{ item.state }}
  with_items:
  #  - { path: '{{ install_dir }}', owner: '{{ prog_user }}', group: '{{ prog_user }}', mode: '0755', state: directory }
    - { path: '{{ supervisor_log_dir }}', owner: '{{ supervisor_run_user }}', group: '{{ supervisor_run_user }}', mode: "0755", state: directory }
    - { path: '{{ supervisor_var_dir }}', owner: '{{ supervisor_run_user }}', group: root, mode: "0755", state: directory }
    - { path: '{{ supervisor_conf_dir }}', owner: '{{ supervisor_run_user }}', group: root, mode: "0755", state: directory }
- name: copy supervisor conf file
  template: src={{ item.src }} dest={{ item.dest }} owner={{ item.owner }} group={{ item.group }} mode={{ item.mode }} backup=yes
  with_items:
    - { src: 'supervisord.conf', dest: '{{ supervisor_conf_dir }}/', owner: '{{supervisor_run_user}}', group: root, mode: "0644"}
  tags:
   - modify_supervisord_conf
  notify:
   - restart supervisord service
- name: create link file
  file: src='{{ supervisor_conf_dir }}/supervisord.conf' dest=/etc/supervisord.conf state=link
  when: '"/etc/supervisord.conf" is not exists'

- include: cent6_service.yml
  #when: ansible_os_family == "RedHat" and ansible_lsb.major_release|int == 6
  # ansible-2.3.0.0
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int == 6

- include: cent7_service.yml
  #when: ansible_os_family == "RedHat" and ansible_lsb.major_release|int == 7
  when: ansible_os_family == "RedHat" and ansible_distribution_major_version|int == 7

- name: set supervisord boot and starting up
  service: name={{ item.name }} state={{ item.state }} enabled=yes
  with_items:
    - { name: "{{supervisor_prog_name}}", state: started }

